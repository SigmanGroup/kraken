# Kraken
In 2024, the code for the Kraken workflow was significantly refactored to streamline the addition of new ligands and improve portability.
This update enables the use of modern software versions including xtb v6.4.0 and crest v2.12 in addition to the original versions of these
programs used to build Kraken (xtb v6.2.2 and crest v2.8). The provided environment is capable of running both versions simply by calling
the desired program version through a subprocess. In our testing, the new workflow performs similarly to the original workflow with several
exceptions depending on the program versions used.

__This software is under active development. The results of this software have not been compared to the original kraken database thoroughly. Use with caution.__

## Installation

1.  Create a conda environment with the included environment yaml file.

    ```bash
    conda env create --name kraken --file=kraken.yml
    ```

2.  Activate the new environment

    ```bash
    conda activate kraken
    ```

3. [Download an appropriate version of xtb and crest](https://github.com/crest-lab/crest). The precompiled versions
   for xtb v6.6.0 and crest v2.12 worked in our testing. Alternatively, CHPC users can use `module load crest` to
   load xTB version 6.4.0 and CREST version 2.12.

4. Place the precompiled binaries for xtb and crest somewhere on your PATH. Kraken will call these through subprocess.

5. Install the `kraken` package by navigating to the parent directory containing `setup.py` and running this command

    ```bash
    pip install .
    ```
## Example Usage

1. Format a .csv file that contains your monophosphine SMILES string, kraken id, and conversion flag.


        +-----------+------------------+-----------------+
        | KRAKEN_ID | SMILES           | CONVERSION_FLAG |
        +-----------+------------------+-----------------+
        | 5039      | CP(C)C           | 4               |
        | 10596     | CP(C1=CC=CC=C1)C | 4               |
        | ...       | ...              | ...             |
        +-----------+------------------+-----------------+


2.  Run Kraken on a .csv file containing the columns 'SMILES', 'KRAKEN_ID', and 'CONVERSION_FLAG'. Here are two examples. <br>

    ```bash
    nohup python3 -u ./run_kraken.py -i input.csv --nprocs 24 > example_output_file.log &
    ```

    ```bash
    nohup python3 -u ./run_kraken.py -i tpp_input.csv --nprocs 24 > triphenyl_phosphine.log &
    ```

## Comparing old and new workflows

## Citing our work
Please cite the original kraken publication if you used this software.

1.  __A Comprehensive Discovery Platform for Organophosphorus Ligands for Catalysis__<br>Tobias Gensch, Gabriel dos Passos Gomes, Pascal Friederich, Ellyn Peters, Théophile Gaudin, Robert Pollice, Kjell Jorner, AkshatKumar Nigam, Michael Lindner-D’Addario, Matthew S. Sigman, and Alán Aspuru-Guzik.
    *J*. *Am*. *Chem*. *Soc*. __2022__ *144* (3), 1205-1217. DOI: 10.1021/jacs.1c09718

## Known Issues
1.  The conformers generated by crest will differ between runs, so it can be difficult to compare xTB properties.
2.  The original version of xTB often fails or produces incorrect results when using the --esp and --vipea flag. Newer versions have not failed in our testing.
3.  The original code is designed to ignore descriptors that are assigned `None` as a result of xTB failure. This behavior is retained.
4.  Despite refactoring, the codebase still contains unused code.
5.  The conda versions of xtb and CREST are incompatible with Kraken. They frequently crashed during the --vipea calculations. The precompiled binaries of each release should be used or compiled directly.

<br>
<br>
<br>
<br>
<br>

# Developer notes

## Differences when using newer SQM programs
1.  Several descriptors vary substantially with xtb 6.7.0 or greater (EA/IP descriptors, nucleophilicity) because IPEA-xTB is not used for vertical IP/EA calculations. This will likely not affect the DFT level descriptors.
2.  Crest v2.12 produces many more conformers than crest v2.8. Because conformers for DFT calculations are selected based on properties, the number of conformers for DFT calculations should remain unchanged.

## Setting up environment for old version of xtb

1.  Activate kraken

    ```bash
    conda activate kraken
    ```
   <br>
2.  Add the desired version of xtb to your path (this is written for development but will be clean in the final docs)

```export PATH=/home/sigman/kraken-xtb/6.2.2/bin/:/home/sigman/opt/openmpi/bin:/home/sigman/orca:/home/sigman/anaconda3/envs/krakendevclean/bin:/home/sigman/anaconda3/condabin:/home/sigman/.vscode/cli/servers/Stable-abd2f3db4bdb28f9e95536dfa84d8479f1eb312d/server/bin/remote-cli:/home/sigman/opt/openmpi/bin:/home/sigman/orca:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin```

3.  export XTBPATH=/home/sigman/xtb/xtb-6.6.0/share/xtb/

4.  Run Kraken on a single ligand

## TODO
1.  Provide details on the differences between xTB descriptors when using different xTB/CREST versions.
2.  Add instructions for installation and using different xtb/crest versions.
3.  Complete docstrings on functions
